name: Deploy to Goldsky

on:
  push:
    tags:
      - "*"

jobs:
  deploy:
    name: Deploy Subgraph
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install Dependencies
        run: npm install

      - name: Install Goldsky CLI
        run: npm install -g @goldskycom/cli

      - name: Codegen
        run: npm run codegen

      - name: Build
        run: npm run build

      - name: Deploy to Goldsky
        env:
          GOLDSKY_API_KEY: ${{ secrets.GOLDSKY_API_KEY }}
        run: |
          # extract version from tag (e.g. v1.0.0 -> v1.0.0)
          VERSION=${GITHUB_REF#refs/tags/}

          echo "Deploying version: $VERSION"

          # Install Goldsky CLI (if not in devDependencies, but it is)
          # We use npx to run the local version

          # Authenticate
          # The CLI is now installed globally
          goldsky login --token $GOLDSKY_API_KEY

          # Deploy directly using the CLI
          goldsky subgraph deploy dd-deposits-subgraph/$VERSION --path .
